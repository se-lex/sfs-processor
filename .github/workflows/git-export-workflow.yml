name: Exportera SFS-data till Git Repository

on:
  schedule:
    # K√∂r varje s√∂ndag kl 03:00 UTC (veckovis export)
    - cron: '0 3 * * 0'
  workflow_dispatch:  # Till√•ter manuell k√∂rning
    inputs:
      export_mode:
        description: 'Export-l√§ge: "all" = alla filer, "changed" = bara nya/√§ndrade sedan senaste veckan'
        required: false
        default: 'changed'
        type: choice
        options:
          - changed
          - all
      years:
        description: '√Ör-intervall att exportera (t.ex. "2024-2026" eller "2024"). Anv√§nds bara i "all"-l√§ge.'
        required: false
        type: string
      branch_name:
        description: 'Git branch namn (l√§mna tom f√∂r auto-genererad med datum)'
        required: false
        type: string
      batch_size:
        description: 'Antal filer per batch'
        required: false
        default: '100'
        type: string
      skip_initial:
        description: 'Hoppa √∂ver initial commits (bara temporal)'
        required: false
        default: false
        type: boolean
      skip_temporal:
        description: 'Hoppa √∂ver temporal commits (bara initial)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  export-to-git:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout workflow-artifact-data branch
      uses: actions/checkout@v4
      with:
        ref: workflow-artifact-data
        fetch-depth: 0  # H√§mta full historik f√∂r git operationer
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify data directories exist
      run: |
        if [ ! -d "data/sfs_json" ]; then
          echo "‚ùå Fel: data/sfs_json katalog finns inte"
          exit 1
        fi
        if [ ! -d "data/md-markers" ]; then
          echo "‚ùå Fel: data/md-markers katalog finns inte"
          exit 1
        fi

        JSON_COUNT=$(find data/sfs_json -name "*.json" | wc -l)
        MD_COUNT=$(find data/md-markers -name "*.md" | wc -l)

        echo "‚úÖ Hittade $JSON_COUNT JSON-filer"
        echo "‚úÖ Hittade $MD_COUNT Markdown-filer"

        if [ "$JSON_COUNT" -eq 0 ]; then
          echo "‚ùå Inga JSON-filer att exportera"
          exit 1
        fi

    - name: Determine export filter
      id: export_filter
      run: |
        EXPORT_MODE="${{ inputs.export_mode || 'changed' }}"
        echo "üìã Export-l√§ge: $EXPORT_MODE"

        if [ "$EXPORT_MODE" = "all" ]; then
          # Exportera alla filer (eller filtrera p√• √•r om specificerat)
          if [ -n "${{ inputs.years }}" ]; then
            echo "üìÖ Exporterar alla filer f√∂r √•r: ${{ inputs.years }}"
            echo "filter=${{ inputs.years }}" >> $GITHUB_OUTPUT
            echo "filter_type=years" >> $GITHUB_OUTPUT
          else
            echo "üìö Exporterar ALLA filer (ingen filtrering)"
            echo "filter=" >> $GITHUB_OUTPUT
            echo "filter_type=none" >> $GITHUB_OUTPUT
          fi
        else
          # Exportera bara nya/√§ndrade filer sedan senaste veckan
          SINCE_DATE=$(date -u -d '7 days ago' +'%Y-%m-%d')
          echo "üîç Letar efter filer √§ndrade sedan: $SINCE_DATE"

          # H√§mta lista p√• √§ndrade JSON-filer fr√•n git log
          CHANGED_FILES=$(git log --since="$SINCE_DATE" --name-only --pretty=format: --diff-filter=AM -- data/sfs_json/ | grep -E '\.json$' | sort -u || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "‚ö†Ô∏è  Inga nya/√§ndrade filer hittades sedan $SINCE_DATE"
            echo "changed_count=0" >> $GITHUB_OUTPUT
            echo "filter=" >> $GITHUB_OUTPUT
            echo "filter_type=none" >> $GITHUB_OUTPUT
            exit 0
          else
            # R√§kna antal √§ndrade filer
            CHANGED_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
            echo "‚úÖ Hittade $CHANGED_COUNT nya/√§ndrade filer"

            # Extrahera beteckningar fr√•n filnamn (sfs-YYYY-NNN.json -> YYYY:NNN)
            BETECKNINGAR=""
            while IFS= read -r file; do
              if [[ $file =~ sfs-([0-9]{4})-([0-9]+)\.json ]]; then
                BETECKNING="${BASH_REMATCH[1]}:${BASH_REMATCH[2]}"
                if [ -z "$BETECKNINGAR" ]; then
                  BETECKNINGAR="$BETECKNING"
                else
                  BETECKNINGAR="$BETECKNINGAR,$BETECKNING"
                fi
              fi
            done <<< "$CHANGED_FILES"

            echo "üìã Filter f√∂r √§ndrade dokument: $BETECKNINGAR"
            echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
            echo "filter=$BETECKNINGAR" >> $GITHUB_OUTPUT
            echo "filter_type=beteckningar" >> $GITHUB_OUTPUT

            # Spara lista f√∂r debugging
            echo ""
            echo "√Ñndrade filer:"
            echo "$CHANGED_FILES"
          fi
        fi

    - name: Determine branch name
      id: branch
      run: |
        if [ -n "${{ inputs.branch_name }}" ]; then
          BRANCH_NAME="${{ inputs.branch_name }}"
        else
          # Auto-generera branch namn med datum
          BRANCH_NAME="export-$(date +'%Y-%m-%d')"
        fi
        echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "üìã Anv√§nder branch: ${BRANCH_NAME}"

    - name: Export to Git repository
      # Skippa om inga √§ndrade filer i "changed" mode
      if: steps.export_filter.outputs.filter_type != 'none' || steps.export_filter.outputs.changed_count != '0'
      env:
        GIT_GITHUB_PAT: ${{ secrets.GIT_GITHUB_PAT }}
        PYTHONPATH: ${{ github.workspace }}
      run: |
        # Bygg kommando med parametrar
        CMD="python exporters/git/batch_export_to_git.py"
        CMD="$CMD --input data/sfs_json"
        CMD="$CMD --markers-dir data/md-markers"
        CMD="$CMD --branch ${{ steps.branch.outputs.branch_name }}"
        CMD="$CMD --batch-size ${{ inputs.batch_size || '100' }}"
        CMD="$CMD --verbose"

        # L√§gg till filter baserat p√• export-l√§ge
        FILTER="${{ steps.export_filter.outputs.filter }}"
        FILTER_TYPE="${{ steps.export_filter.outputs.filter_type }}"

        if [ -n "$FILTER" ]; then
          if [ "$FILTER_TYPE" = "years" ]; then
            CMD="$CMD --years $FILTER"
            echo "üìÖ Filtrerar f√∂r √•r: $FILTER"
          elif [ "$FILTER_TYPE" = "beteckningar" ]; then
            CMD="$CMD --filter $FILTER"
            echo "üìã Filtrerar f√∂r beteckningar: $FILTER"
          fi
        fi

        # L√§gg till skip flags om specificerade
        if [ "${{ inputs.skip_initial }}" = "true" ]; then
          CMD="$CMD --skip-initial"
          echo "‚è≠Ô∏è  Hoppar √∂ver initial commits"
        fi

        if [ "${{ inputs.skip_temporal }}" = "true" ]; then
          CMD="$CMD --skip-temporal"
          echo "‚è≠Ô∏è  Hoppar √∂ver temporal commits"
        fi

        echo "K√∂r: $CMD"
        echo ""

        # K√∂r export
        eval $CMD

    - name: No files to export
      if: steps.export_filter.outputs.changed_count == '0' && inputs.export_mode == 'changed'
      run: |
        echo "‚ÑπÔ∏è  Inga nya/√§ndrade filer att exportera sedan senaste veckan"
        echo "K√∂rningen avslutas utan fel"

    - name: Export summary
      if: success()
      run: |
        echo "‚úÖ Git export slutf√∂rd!"
        echo "Branch: ${{ steps.branch.outputs.branch_name }}"
        echo "Target repo: se-lex/sfs (konfigurerat via GIT_TARGET_REPO env var)"
        echo ""
        echo "N√§sta steg:"
        echo "1. G√• till se-lex/sfs repository"
        echo "2. Skapa Pull Request fr√•n branch '${{ steps.branch.outputs.branch_name }}'"
        echo "3. Granska och merga till main"

    - name: Export failed
      if: failure()
      run: |
        echo "‚ùå Git export misslyckades!"
        echo "Kontrollera:"
        echo "1. GIT_GITHUB_PAT secret √§r korrekt konfigurerad"
        echo "2. PAT har skrivr√§ttigheter till target repository"
        echo "3. Data finns i workflow-artifact-data branch"
        echo "4. Loggar ovan f√∂r feldetaljer"
